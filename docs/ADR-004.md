# ADR-003: Elección de la tecnología de persistencia y repositorios

## Contexto


Era necesario implementar una capa de persistencia que permitiera almacenar y recuperar datos relacionados con los tickets de forma eficiente, manteniendo una buena separación de responsabilidades y cumpliendo con la arquitectura hexagonal del proyecto.

Se buscaba una solución que:

- Permitiera mapear fácilmente tablas relacionales a objetos de dominio.
- Simplificara operaciones comunes como guardar, actualizar o consultar por atributos.
- Fuera compatible con una base de datos relacional robusta y ampliamente utilizada.

Además, la arquitectura requería separar los repositorios de dominio de la infraestructura, permitiendo desacoplar la lógica de acceso a datos del resto del sistema.

## Decisión

Para la persistencia de datos se eligió el motor de base de datos SQL Server.
Se está utilizando a través de una imagen Docker, facilitando así el entorno de
desarrollo y pruebas. La aplicación se conecta a esta base de datos utilizando la
dirección `host.docker.internal` para que desde el contenedor del backend pueda acceder
a la base de datos que corre en otro contenedor.

En cuanto al acceso y mapeo de datos, se eligió JPA (Java Persistence API) como tecnología ORM.
Esta decisión se tomó porque JPA permite mapear tablas relacionales a clases Java de forma
sencilla, facilitando operaciones como guardar, consultar y buscar datos con métodos ya
predeterminados, reduciendo así la necesidad de escribir SQL manualmente.

Además, se creó un repositorio de dominio (`TicketRepository`) y se implementó una clase
adaptadora (`TicketRepositoryImpl`) que usa internamente un repositorio de Spring Data JPA
(`TicketJPARepository`).

## Detalle de implementación

Se cuenta con implementaciones de repositorios que permiten devolver objetos de dominio
hacia las capas superiores.

La estructura utilizada es la siguiente:

### Repositorio de dominio

```java

public interface TicketRepository {
    List<Ticket> findAll();
    Ticket findById(Long id);
    Ticket save(Ticket ticket);
}
```

### Repositorio de Spring Data JPA

```java

public interface TicketJPARepository extends JpaRepository<TicketEntity, Long> {
}
```

### Adaptador de repositorio

```java
@Repository
@RequiredArgsConstructor
public class TicketRepositoryImpl implements TicketRepository {

    private final TicketJPARepository ticketJpaRepository;

    @Override
    public List<Ticket> findAll() {
        return ticketJpaRepository.findAll().stream().map(TicketMapper::toModel).toList();
    }

    @Override
    public Ticket findById(Long id) {
        return ticketJpaRepository.findById(id)
                .map(TicketMapper::toModel)
                .orElseThrow(() -> new TicketNotFoundException("No ticket with id " + id));
    }

    @Override
    public Ticket save(Ticket ticket) {
        TicketEntity ticketEntity = TicketMapper.toEntity(ticket);
        return Optional.of(TicketMapper.toModel(ticketJpaRepository.save(ticketEntity)))
                .orElseThrow(() -> new RuntimeException("An error occurred while saving the ticket"));
    }
}

```

